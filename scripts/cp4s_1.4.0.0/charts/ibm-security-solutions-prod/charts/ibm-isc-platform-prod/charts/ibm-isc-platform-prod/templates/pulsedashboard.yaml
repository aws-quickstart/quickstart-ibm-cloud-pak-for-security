apiVersion: isc.ibm.com/v1
kind: ISCComponent
metadata:
  name: pulsedashboard
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    release: {{ .Release.Name }}
    app.kubernetes.io/instance: default
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  action:
    name: pulse install
    operation: generic-install
    service:
      name: pulsedashboard
      ports:
        - 3011
    {{- include "platform.annotate" . }}
    {{- include "ibm-isc-platform.podcfg" (dict "val" . "app" "pulse") }}
    env:
      - name: APP_FQDN
        value: "@inventory/domain/definitions/name"
      - name: DEFAULT_HOST
        value: "@inventory/domain/definitions/name"
        format: "https://{0}"
      - name: COUCHDB_HOSTNAME
        value: '@inventory/couch/definitions/url'
      - name: COUCHDB_USERNAME
        value: '@secret/couchdb/username'
      - name: COUCHDB_PASSWORD
        value: '@secret/couchdb/password'
      - name: COUCHDB_NAME
        value: "pulsebackend"
      - name: SEARCH_COUCH_USERNAME
        value: '@secret/couch/username'
      - name: SEARCH_COUCH_PASSWORD
        value: '@secret/couch/password'
      - name: SEARCH_TASKS_COUCHDB_NAME
        value: "pulse-search-tasks"
      - name: SEARCH_RESULTS_CACHE_COUCHDB_NAME
        value: "pulse-search-results"
      - name: REJECTED_SEARCH_TASKS_COUCHDB_NAME
        value: "pulse-search-rejected"
      - name: MAX_CONCURRENT_SEARCHES_AQL
        value: '@inventory/platform/definitions/pulse/max_concurrent_searches_aql'
      - name: SEARCH_TIMEOUT_AQL
        value: '@inventory/platform/definitions/pulse/search_timeout_aql'
      - name: OPENSHIFT_ENV
        value: true
      - name: PULSE_RESTRICTED
        value: '@inventory/platform/definitions/featureflags/pulse_restricted'

    liveness_probe:
      path: /liveness
    readiness_probe:
      path: /readiness
    paths:
      - ingress: /pulse
        app: /pulse
        noAuth: true
        timeout: 60000
      - ingress: /pulse/api
        app: /pulse/api
        timeout: 60000
